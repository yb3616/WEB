<template>
    <v-content>
        <v-container fluid fill-height>
            <v-layout align-center justify-center>
                <v-flex xs12 sm8 md4>
                    <v-card class="elevation-12">
                        <v-toolbar dark color="primary">
                            <v-toolbar-title>登录框</v-toolbar-title>
                            <v-spacer></v-spacer>
                            <v-btn depressed flat large to="/register">注册</v-btn>
                        </v-toolbar>
                        <v-card-text>
                            <v-form ref="form" v-model="valid" lazy-validation>
                                <v-text-field
                                    v-model="loginid"
                                    :rules="loginidRules"
                                    label="请输入用户名或 手机号或 邮箱"
                                    clearable
                                    single-line
                                    required
                                    ></v-text-field>
                                <v-text-field
                                    :append-icon="e1 ? 'visibility' : 'visibility_off'"
                                    :append-icon-cb="() => (e1 = !e1)"
                                    :type="!e1 ? 'password' : 'text'"
                                    label="登录密码"
                                    single-line
                                    v-model="password"
                                    required
                                    :rules= 'passwordRules'
                                    ></v-text-field>
                            </v-form>
                        </v-card-text>
                        <v-card-actions>
                            <v-btn @click="forgetPassword" flat large>忘记密码</v-btn>
                            <v-spacer></v-spacer>
                            <v-btn :disabled="!valid" @click="login" flat large>提交数据</v-btn>
                        </v-card-actions>
                    </v-card>
                </v-flex>
            </v-layout>
        </v-container>
        <v-dialog
            v-model="dialog"
            max-width="290"
            >
            <v-card>
                <v-card-title class="headline">验证失败</v-card-title>

                <v-card-text>
                    请检查账号、密码是否匹配
                </v-card-text>

                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn
                        color="primary darken-1"
                        flat="flat"
                        @click="dialog = false"
                        >
                        确定
                    </v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>
    </v-content>
</template>

<script>
export default {
    data() {
        return {
            dialog: false,
            valid: true,
            loginid: '',
            loginidRules: [
                v => !!v || '必须填入账号',
                v => /^1\d{10}$/.test(v) || /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/.test(v) || /^[a-zA-Z]+\w{3,}$/.test(v) || '账号格式不正确',
            ],
            e1: false,
            password: '',
            passwordRules: [
                v => !!v || '必须填入密码',
                v => v.length >= 6 || '最少六位密码',
            ],
        };
    },
    methods:{
        forgetPassword: function() {
        },
        login: function() {
            if (this.$refs.form.validate()) {
                var data
                if (/^1\d{10}$/.test(this.loginid)) {
                    var data = {
                        phone:    this.loginid,
                        password: this.password,
                    }
                } else if (/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/.test(this.loginid)) {
                    var data = {
                        email:    this.loginid,
                        password: this.password,
                    }
                } else if (/^[a-zA-Z]+\w{3,}$/.test(this.loginid)) {
                    var data = {
                        user_name:    this.loginid,
                        password: this.password,
                    }
                }

                this.$http.post('/login', data).then( resp => {
                    if ("success" == resp.data.msg) {
                        this.$http.get("/user/info").then( result => {
                            if ("success" == result.data.msg) {
                                this.$store.commit('login', result.data.result)
                                this.$router.back(-1);
                            } else {
                                console.log(result);
                            }
                        }).catch( err => {
                            console.log(err);
                        })
                    } else {
                        this.dialog = true
                    }
                }).catch( err => {
                    console.log(err);
                })
            }
        }
    },
    mounted() {
    },
};
</script>
